.row
  .col-xs-12
    .panel.panel-default
      .panel-heading
        .panel-title
          = @round.title
          %small.pull-right
            .label.label-primary
              = @round.check_finish? ? t('rounds.deadline_off') : t('rounds.deadline', date: deadline(@round.deadline))

      %table.table.table-condensed.rounds
        %thead
          %th
          %th
          - @users.each do |user|
            %th.results(style="text-align:center;font-weight:100;")
              %p
                = link_to [user, :profile] do
                  = user.profile.surname || user.email.split('@').first

              - result = user.results.where(round_id: @round).first
              - if result
                .tip
                  .badge.badge-success= result.total
                  - if result.total > 0
                    .tip-text
                      - a,b,c,d = 0, 0, 0, 0
                      - result.matches.each do |match|
                        - if match.has_goal?
                          - forecast = user.forecasts.where(match_id: match.id).last
                          - if forecast
                            - a+=1 if (match.team1goal == forecast.team1goal) && (match.team2goal == forecast.team2goal) && (match.check_win == forecast.check_winner)
                            - b+=1 if (match.team1goal - match.team2goal) == (forecast.team1goal - forecast.team2goal)
                            - c+=1 if (match.check_win == forecast.check_winner)
                            - d+=1 if (match.ending == forecast.ending && !@round.draw)
                      %dl.dl-horizontal
                        - if a > 0
                          %p
                            %span.badge.badge-success + #{a}
                            = t 'results.true_match'
                        - if b > 0
                          %p
                            %span.badge.badge-success + #{b}
                            = t 'results.true_diff'
                        - if c > 0
                          %p
                            %span.badge.badge-success + #{c}
                            = t 'results.true_winner'
                        - if d > 0
                          %p
                            %span.badge.badge-success + #{d}
                            = t 'results.true_final_end'
              - else
                .badge.badge-success 0

          - if @round.check_finish?
            %th= t 'shared.mid'
        %tbody
          - if @round.allow_empty?
            - hidden_matches = @round_matches.where('matches.desc is null or matches.desc <> ?', '')

            = render partial: 'match', collection: (@round_matches - hidden_matches)

            - if @round.content? && !@round.check_finish?
              %tr
                %td(colspan=17)
                  .col-xs-6.alert.alert-danger.col-xs-offset-3
                    = @round.content

            - %w[final 3final].each do |type|
              %tr
                %td(colspan=17)
                  %h4= t "rounds.#{type}"
              - hidden_matches.where(desc: type).each do |match|
                = render partial: 'match', locals: { match: match }
          - else
            = render partial: 'match', collection: @round_matches

      .panel-footer
        = link_to t('shared.back'), rounds_path, class: 'btn btn-default btn-sm'
        .pull-right
          - if can? :download, @round
            = link_to download_round_path(@round, format: 'pdf'), class: 'btn btn-default btn-sm', target: '_blank' do
              = fa_icon 'file-pdf-o', text: t('rounds.download')

          - if can? :manage, @round
            = link_to rebuild_results_path(round: @round.id), remote: true, method: :post, class: 'btn btn-default btn-sm' do
              = fa_icon 'refresh', text: t('results.rebuild')

            = link_to t('shared.edit'), edit_round_path(@round), class: 'btn btn-default btn-sm'
            = link_to t('shared.del'), round_path(@round), method: :delete, data: { confirm: t('shared.sure') }, class: 'btn btn-danger btn-sm'
